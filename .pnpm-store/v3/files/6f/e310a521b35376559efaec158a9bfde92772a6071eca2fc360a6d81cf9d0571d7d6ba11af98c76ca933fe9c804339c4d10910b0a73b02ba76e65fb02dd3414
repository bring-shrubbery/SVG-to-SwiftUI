import fs from "fs";
import { builtinModules } from "module";
import { fileURLToPath } from "url";
import * as vite from "vite";
import astroPostprocessVitePlugin from "../vite-plugin-astro-postprocess/index.js";
import astroViteServerPlugin from "../vite-plugin-astro-server/index.js";
import astroVitePlugin from "../vite-plugin-astro/index.js";
import configAliasVitePlugin from "../vite-plugin-config-alias/index.js";
import envVitePlugin from "../vite-plugin-env/index.js";
import astroIntegrationsContainerPlugin from "../vite-plugin-integrations-container/index.js";
import jsxVitePlugin from "../vite-plugin-jsx/index.js";
import markdownVitePlugin from "../vite-plugin-markdown/index.js";
import astroScriptsPlugin from "../vite-plugin-scripts/index.js";
const ALWAYS_EXTERNAL = /* @__PURE__ */ new Set([
  ...builtinModules.map((name) => `node:${name}`),
  "@sveltejs/vite-plugin-svelte",
  "micromark-util-events-to-acorn",
  "@astrojs/markdown-remark",
  "node-fetch",
  "prismjs",
  "shiki",
  "unified",
  "whatwg-url"
]);
const ALWAYS_NOEXTERNAL = /* @__PURE__ */ new Set([
  "astro",
  "@nanostores/preact"
]);
async function createVite(commandConfig, { astroConfig, logging, mode }) {
  const astroPackages = await getAstroPackages(astroConfig);
  const commonConfig = {
    cacheDir: fileURLToPath(new URL("./node_modules/.vite/", astroConfig.root)),
    clearScreen: false,
    logLevel: "warn",
    optimizeDeps: {
      entries: ["src/**/*"],
      exclude: ["node-fetch"]
    },
    plugins: [
      configAliasVitePlugin({ config: astroConfig }),
      astroVitePlugin({ config: astroConfig, logging }),
      astroScriptsPlugin({ config: astroConfig }),
      mode === "dev" && astroViteServerPlugin({ config: astroConfig, logging }),
      envVitePlugin({ config: astroConfig }),
      markdownVitePlugin({ config: astroConfig }),
      jsxVitePlugin({ config: astroConfig, logging }),
      astroPostprocessVitePlugin({ config: astroConfig }),
      astroIntegrationsContainerPlugin({ config: astroConfig })
    ],
    publicDir: fileURLToPath(astroConfig.publicDir),
    root: fileURLToPath(astroConfig.root),
    envPrefix: "PUBLIC_",
    define: {
      "import.meta.env.SITE": astroConfig.site ? `'${astroConfig.site}'` : "undefined"
    },
    server: {
      force: true,
      hmr: process.env.NODE_ENV === "test" || process.env.NODE_ENV === "production" ? false : void 0,
      proxy: {},
      watch: {
        ignored: mode === "build" ? ["**"] : void 0
      }
    },
    css: {
      postcss: astroConfig.style.postcss || {}
    },
    resolve: {
      alias: [
        {
          find: "randombytes",
          replacement: "randombytes/browser"
        },
        {
          find: /^astro$/,
          replacement: fileURLToPath(new URL("../@types/astro", import.meta.url))
        }
      ],
      conditions: ["astro"]
    },
    ssr: {
      external: [...ALWAYS_EXTERNAL],
      noExternal: [...ALWAYS_NOEXTERNAL, ...astroPackages]
    }
  };
  let result = commonConfig;
  result = vite.mergeConfig(result, astroConfig.vite || {});
  result = vite.mergeConfig(result, commandConfig);
  sortPlugins(result);
  return result;
}
function getPluginName(plugin) {
  if (plugin && typeof plugin === "object" && !Array.isArray(plugin)) {
    return plugin.name;
  }
}
function sortPlugins(result) {
  var _a, _b, _c, _d, _e;
  const mdxPluginIndex = ((_a = result.plugins) == null ? void 0 : _a.findIndex((plugin) => getPluginName(plugin) === "@mdx-js/rollup")) ?? -1;
  if (mdxPluginIndex === -1)
    return;
  const jsxPluginIndex = ((_b = result.plugins) == null ? void 0 : _b.findIndex((plugin) => getPluginName(plugin) === "astro:jsx")) ?? -1;
  const mdxPlugin = (_c = result.plugins) == null ? void 0 : _c[mdxPluginIndex];
  (_d = result.plugins) == null ? void 0 : _d.splice(mdxPluginIndex, 1);
  (_e = result.plugins) == null ? void 0 : _e.splice(jsxPluginIndex, 0, mdxPlugin);
}
async function getAstroPackages({ root }) {
  const pkgUrl = new URL("./package.json", root);
  const pkgPath = fileURLToPath(pkgUrl);
  if (!fs.existsSync(pkgPath))
    return [];
  const pkg = JSON.parse(fs.readFileSync(pkgPath, "utf8"));
  const deps = [...Object.keys(pkg.dependencies || {}), ...Object.keys(pkg.devDependencies || {})];
  return deps.filter((dep) => {
    if (isCommonNotAstro(dep))
      return false;
    if (/^astro\-/.test(dep))
      return true;
    const depPkgUrl = new URL(`./node_modules/${dep}/package.json`, root);
    const depPkgPath = fileURLToPath(depPkgUrl);
    if (!fs.existsSync(depPkgPath))
      return false;
    const {
      dependencies = {},
      peerDependencies = {},
      keywords = []
    } = JSON.parse(fs.readFileSync(depPkgPath, "utf-8"));
    if (peerDependencies.astro || dependencies.astro)
      return true;
    if (keywords.includes("astro") || keywords.includes("astro-component"))
      return true;
    return false;
  });
}
const COMMON_DEPENDENCIES_NOT_ASTRO = [
  "autoprefixer",
  "react",
  "react-dom",
  "preact",
  "preact-render-to-string",
  "vue",
  "svelte",
  "solid-js",
  "lit",
  "cookie",
  "dotenv",
  "esbuild",
  "eslint",
  "jest",
  "postcss",
  "prettier",
  "astro",
  "tslib",
  "typescript",
  "vite"
];
const COMMON_PREFIXES_NOT_ASTRO = [
  "@webcomponents/",
  "@fontsource/",
  "@postcss-plugins/",
  "@rollup/",
  "@astrojs/renderer-",
  "@types/",
  "@typescript-eslint/",
  "eslint-",
  "jest-",
  "postcss-plugin-",
  "prettier-plugin-",
  "remark-",
  "rehype-",
  "rollup-plugin-",
  "vite-plugin-"
];
function isCommonNotAstro(dep) {
  return COMMON_DEPENDENCIES_NOT_ASTRO.includes(dep) || COMMON_PREFIXES_NOT_ASTRO.some((prefix) => prefix.startsWith("@") ? dep.startsWith(prefix) : dep.substring(dep.lastIndexOf("/") + 1).startsWith(prefix));
}
export {
  createVite
};
