var b=(e,t,n)=>{e.setAttribute(t,new URL(e.getAttribute(t),n).pathname)};function R(e,t){e.querySelectorAll('[href^="./"], [href^="../"]').forEach(n=>b(n,"href",t)),e.querySelectorAll('[src^="./"], [src^="../"]').forEach(n=>b(n,"src",t))}var h=e=>(t,n)=>t[`node${e}`]===n[`node${e}`],D=h("Name"),v=h("Type"),C=h("Value");function M(e,t){if(e.attributes.length===0&&t.attributes.length===0)return[];let n=[],r=new Map,s=new Map;for(let o of e.attributes)r.set(o.name,o.value);for(let o of t.attributes){let i=r.get(o.name);o.value===i?r.delete(o.name):(typeof i<"u"&&r.delete(o.name),s.set(o.name,o.value))}for(let o of r.keys())n.push({type:5,name:o});for(let[o,i]of s.entries())n.push({type:4,name:o,value:i});return n}function N(e,t=!0){let n=`${e.localName}`;for(let{name:r,value:s}of e.attributes)t&&r.startsWith("data-")||(n+=`[${r}=${s}]`);return n+=e.innerHTML,n}function T(e){switch(e.tagName){case"BASE":case"TITLE":return e.localName;case"META":{if(e.hasAttribute("name"))return`meta[name="${e.getAttribute("name")}"]`;if(e.hasAttribute("property"))return`meta[name="${e.getAttribute("property")}"]`;break}case"LINK":{if(e.hasAttribute("rel")&&e.hasAttribute("href"))return`link[rel="${e.getAttribute("rel")}"][href="${e.getAttribute("href")}"]`;if(e.hasAttribute("href"))return`link[href="${e.getAttribute("href")}"]`;break}}return N(e)}function $(e){let[t,n=""]=e.split("?"),r=new URLSearchParams(n);return r.set("t",`${Date.now()}`),`${t}?${r}`}function u(e){if(e.nodeType===1&&e.hasAttribute("data-persist"))return e;if(e.nodeType===1&&e.localName==="script"){let t=document.createElement("script");for(let{name:n,value:r}of e.attributes)n==="src"&&(r=$(r)),t.setAttribute(n,r);return t.innerHTML=e.innerHTML,t}return e.cloneNode(!0)}function S(e,t){if(e.children.length===0&&t.children.length===0)return[];let n=[],r=new Map,s=new Map,o=new Map;for(let i of e.children)r.set(T(i),i);for(let i of t.children){let a=T(i),c=r.get(a);c?N(i,!1)!==N(c,!1)&&s.set(a,u(i)):o.set(a,u(i)),r.delete(a)}for(let i of e.childNodes){if(i.nodeType===1){let a=T(i);if(r.has(a)){n.push({type:1});continue}else if(s.has(a)){let c=s.get(a);n.push({type:3,attributes:M(i,c),children:L(i,c)});continue}}n.push(void 0)}for(let i of o.values())n.push({type:0,node:u(i)});return n}function L(e,t){let n=[],r=Math.max(e.childNodes.length,t.childNodes.length);for(let s=0;s<r;s++){let o=e.childNodes.item(s),i=t.childNodes.item(s);n[s]=p(o,i)}return n}function p(e,t){if(!e)return{type:0,node:u(t)};if(!t)return{type:1};if(v(e,t)){if(e.nodeType===3){let n=e.nodeValue,r=t.nodeValue;if(n.trim().length===0&&r.trim().length===0)return}if(e.nodeType===1){if(D(e,t)){let n=e.tagName==="HEAD"?S:L;return{type:3,attributes:M(e,t),children:n(e,t)}}return{type:2,node:u(t)}}else return e.nodeType===9?p(e.documentElement,t.documentElement):C(e,t)?void 0:{type:2,value:t.nodeValue}}return{type:2,node:u(t)}}function V(e,t){if(t.length!==0)for(let{type:n,name:r,value:s}of t)n===5?e.removeAttribute(r):n===4&&e.setAttribute(r,s)}async function _(e,t,n){if(!t)return;let r;switch(e.nodeType===9?(e=e.documentElement,r=e):n?r=n:r=e,t.type){case 0:{let{node:s}=t;e.appendChild(s);return}case 1:{if(!r)return;e.removeChild(r);return}case 2:{if(!r)return;let{node:s,value:o}=t;if(typeof o=="string"){r.nodeValue=o;return}r.replaceWith(s);return}case 3:{if(!r)return;let{attributes:s,children:o}=t;V(r,s);let i=Array.from(r.childNodes);await Promise.all(o.map((a,c)=>_(r,a,i[c])));return}}}function w(e,t){let n=p(e,t);return _(e,n)}var k=e=>e.nodeType===1,Y=e=>{try{let t=new URL(e);if(window.location.origin===t.origin)return t.pathname===window.location.pathname?!t.hash:!0}catch{}return!1},q=({target:e})=>{if(!k(e))return;let t=e.closest("a");if(!t)return;let{href:n}=t;if(!!Y(n))return new URL(n)},x=()=>{},g;async function I(e,t=!1,n){let{beforeDiff:r=x,afterDiff:s=x}=n;g=g||new DOMParser;let o=await fetch(`${e}`).then(c=>c.text()).catch(()=>{window.location.assign(e)});if(!o)return;t||(history.pushState({},"",e),window.scrollTo({top:0}));let i=g.parseFromString(o,"text/html");R(i,e),r(i);let a=i.querySelector("title");a&&(document.title=a.text),await w(document,i),s()}function z(e={}){typeof window<"u"&&(window.addEventListener("click",async t=>{let n=q(t);if(!!n){t.preventDefault();try{I(n,!1,e)}catch{window.location.assign(n)}}}),window.addEventListener("popstate",()=>{if(!window.location.hash)try{I(new URL(window.location.toString()),!0,e)}catch{window.location.reload()}}))}export{z as default};
